<div>
    <style>
        .chat-list > .chat-item {
            /* padding: .5rem; */
            display: flex;
        }
        .chat-list > .chat-item > .avatar {
            padding: 5px;
            height: 30px;
            width: 30px;
        }
        .chat-list > .chat-item > .right {
            width: fit-content;
            margin: 5px;
            display: flex;
            flex-direction: column;
        }
        .chat-list > .chat-item > .right > .name {
            margin-left: 10px;
        }
        .chat-list > .chat-item .content {
            border-radius: 5px;
            border: 1px #eee;
            padding: 10px;
            background-color: rgb(61, 58, 58);
            white-space: break-spaces;
            margin-top: 5px;
            width: fit-content;
        }
        .chat-list > .self {
            flex-flow: row-reverse;
        }
        .chat-list > .self > .right {
            flex-wrap: wrap-reverse;
        }
        /*元素渲染*/
        .chat-list > .chat-item .content .ele-image {
            max-width: 500px;
            max-height: 200px;
        }
        /*编辑区域*/
        .edit-area {
            width: 100%;
            height: 200px;
            background-color: gray;
            white-space: pre;
        }
        .edit-area:focus-visible {
            outline: none;
        }
        .edit-area img{
            max-height: 100px;
            max-width: 100px;
        }
        .msg-input {
            position: sticky;
            bottom: 0;
            background-color: black;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
    <div id="chat-list" class="chat-list">
        <!-- <div class="chat-item self">
            <div class="avatar">
                头像
            </div>
            <div>
                <span>我的昵称</span>
                <div>我的消息,121323<br>15454asdafbj</div>
            </div>
        </div> -->
    </div>
    <br />
    <div class="msg-input">
        <!-- 表情 -->
        <link rel="stylesheet" type="text/css" href="./group-chat.css" />
        <div class="face-emoji">
            <span>表情</span>
            <div class="detail-area">表情区域</div>
        </div>
        <br />
        <div id="msg-elements" contenteditable="true" class="edit-area"></div>
        <button id="send-msg">发送</button>
    </div>
    <script src="./group-chat.js"></script>
    <script>
        const renderElementMap = {
            text: async (data) => {
                return `<span class="ele-text">${data.text}</span>`
            },
            image: async (data) => {
                if (data.pic.url.startsWith('http'))
                    return `<img class="ele-image" src="${data.pic.url}" />`
                const ret = await sendToMain('get_url', {path: data.pic.path})
                return `<img class="ele-image" src="${ret}" />`
            }
        }
        const renderElement = async (element) => {
            if (renderElementMap[element.type])
            {
                return await renderElementMap[element.type](element.data)
            }
            console.warn('不支持的元素类型:', element.type)
            return ''
        }
        const renderMsgItem = async (msg) => {
            console.log('render msg...')
            const msgEle = document.createElement('div')
            msgEle.classList.add('chat-item')
            if (msg.senderUid === selfUid)
            {
                msgEle.classList.add('self')
            }
            let name = msg.senderMemberName
            if (name.length === 0)
            {
                const info = await sendToWSServer('get_user_info', {
                        userUid: msg.senderUid,
                    })
                name = info.nick
            }
            const { elements } = msg
            
            msgEle.innerHTML = `
            <div class="avatar">
                <img src="http://q2.qlogo.cn/headimg_dl?dst_uin=${msg.senderId}&spec=100" />
            </div>
            <div class="right">
                <span class="name">${name}</span>
                <div class="content">${(await Promise.all(elements.map(async ele => await renderElement(ele)))).join('')}</div>
            </div>
            `
            return msgEle
        }
        const addOldMsgToList = async (msgList) => {
            const list = document.getElementById('chat-list')
            msgList = msgList.reverse()
            for (const msg of msgList) {
                list.prepend(await renderMsgItem(msg))
            }
        };
        (async () => {
            // 获取群消息
            console.log('start to get group msg')
            const list = await sendToWSServer('get_group_msg', {
                    code: groupCode,
                    msgId: '0',
                    cnt: 10
                })
            console.log('group msg list:', list)
            addOldMsgToList(list)
        })();
    </script>
</div>